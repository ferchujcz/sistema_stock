{% extends 'core/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Inventario Físico - {{ sucursal_actual.nombre|default:"Mi Sucursal" }}</h4>
            </div>
            <div class="card-body">
                <p class="lead">Escaneá o buscá un producto, ingresá la cantidad física encontrada y añadilo a la lista. Al finalizar, compará con el sistema.</p>
                
                <div class="row g-3 align-items-end mb-3 p-3 bg-light border rounded">
                    <div class="col-md-6">
                        <label for="buscar-scan-producto" class="form-label fw-bold">Buscar por Nombre o Escanear Código</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="buscar-scan-producto" class="form-control" placeholder="Escanear o tipear...">
                        </div>
                        <div id="resultados-busqueda-inv" class="list-group position-absolute" style="z-index: 1000; width: 95%;"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="cantidad-contada" class="form-label fw-bold">Cantidad Contada</label>
                        <input type="number" id="cantidad-contada" class="form-control" min="0" value="1">
                    </div>
                    <div class="col-md-3">
                        <button type="button" id="btn-anadir-conteo" class="btn btn-primary w-100">Añadir a Lista</button>
                    </div>
                </div>

                <hr>

                <form id="form-inventario" method="post">
                    {% csrf_token %}
                    <h4>Productos Contados en esta Sesión:</h4>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tabla-conteo">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th style="width: 150px;">Cantidad Contada</th>
                                    <th style="width: 80px;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="fila-vacia" class="d-none">
                                    <td colspan="3" class="text-center text-muted">Aún no se han añadido productos al conteo.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Finalizar Conteo y Comparar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Referencias a elementos ---
    const buscarInput = document.getElementById('buscar-scan-producto');
    const resultadosDiv = document.getElementById('resultados-busqueda-inv');
    const cantidadInput = document.getElementById('cantidad-contada');
    const anadirBtn = document.getElementById('btn-anadir-conteo');
    const tablaBody = document.querySelector('#tabla-conteo tbody');
    const filaVacia = document.getElementById('fila-vacia');
    
    let productoSeleccionado = null;
    let conteoActual = {}; // Objeto para guardar {id: {nombre: '...', cantidad: 0}}
    
    // --- Lógica de Búsqueda ---
    buscarInput.addEventListener('keyup', function(event) {
        productoSeleccionado = null;
        if (event.key === 'Enter') {
            event.preventDefault();
            const codigo = buscarInput.value.trim();
            if (codigo) buscarPorCodigo(codigo);
        } else {
            buscarPorNombre(buscarInput.value);
        }
    });

    function buscarPorCodigo(codigo) {
        fetch(`/api/buscar-por-codigo/?codigo=${codigo}`)
            .then(response => {
                resultadosDiv.innerHTML = '';
                if (!response.ok) { buscarInput.classList.add('is-invalid'); throw new Error('No encontrado'); }
                buscarInput.classList.remove('is-invalid');
                return response.json();
            })
            .then(producto => seleccionarProducto(producto))
            .catch(error => {
                alert(error.message);
                buscarInput.value = '';
            });
    }

    function buscarPorNombre(query) {
         if (query.length < 2) {
            resultadosDiv.innerHTML = '';
            return;
        }
        fetch(`/api/buscar-productos/?term=${query}`)
            .then(response => response.json())
            .then(data => {
                resultadosDiv.innerHTML = '';
                data.forEach(producto => {
                    const div = document.createElement('div');
                    div.innerHTML = producto.nombre;
                    div.classList.add('list-group-item', 'list-group-item-action');
                    div.style.cursor = 'pointer';
                    div.onclick = () => seleccionarProducto(producto);
                    resultadosDiv.appendChild(div);
                });
            });
    }

    function seleccionarProducto(producto){
        productoSeleccionado = producto;
        buscarInput.value = producto.nombre;
        resultadosDiv.innerHTML = '';
        cantidadInput.focus();
        cantidadInput.select();
    }
    
    // --- Lógica de Conteo ---
    anadirBtn.addEventListener('click', anadirALista);
    cantidadInput.addEventListener('keypress', function(event){
        if (event.key === 'Enter'){
            event.preventDefault();
            anadirALista();
        }
    });
    
    function anadirALista(){
        if (!productoSeleccionado) {
            alert("Primero busca o escanea un producto.");
            buscarInput.focus();
            return;
        }
        const cantidad = parseInt(cantidadInput.value);
        if (isNaN(cantidad) || cantidad < 0) {
             alert("Ingresa una cantidad válida (0 o mayor).");
             cantidadInput.focus();
             return;
        }
        
        // --- MEJORA ---
        // Guardamos el objeto completo, no solo la cantidad
        conteoActual[productoSeleccionado.id] = {
            nombre: productoSeleccionado.nombre,
            cantidad: cantidad
        };
        
        actualizarTablaVisual();
        
        productoSeleccionado = null;
        buscarInput.value = '';
        cantidadInput.value = '1';
        buscarInput.focus();
    }
    
    function actualizarTablaVisual(){
        tablaBody.innerHTML = ''; // Limpiar tabla
        
        if (Object.keys(conteoActual).length === 0) {
            filaVacia.classList.remove('d-none');
            tablaBody.appendChild(filaVacia);
        } else {
            for (const prodId in conteoActual) {
                const item = conteoActual[prodId]; // Obtenemos el objeto {nombre, cantidad}
                
                const tr = document.createElement('tr');
                tr.dataset.productId = prodId;
                tr.innerHTML = `
                    <td>
                        ${item.nombre} <input type="hidden" name="producto_id_${prodId}" value="${prodId}">
                    </td>
                    <td>
                        <input type="number" class="form-control" name="cantidad_contada_${prodId}" value="${item.cantidad}" min="0">
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarItem(${prodId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tablaBody.appendChild(tr);
            }
        }
    }
    
    window.eliminarItem = function(productId){
        delete conteoActual[productId];
        actualizarTablaVisual();
    }
    
    // Listener para actualizar el objeto si se cambia la cantidad en la tabla
    tablaBody.addEventListener('change', function(event){
        if(event.target.type === 'number'){
            const fila = event.target.closest('tr');
            const prodId = fila.dataset.productId;
            const nuevaCantidad = parseInt(event.target.value);
            if(conteoActual[prodId] && !isNaN(nuevaCantidad) && nuevaCantidad >= 0){
                conteoActual[prodId].cantidad = nuevaCantidad;
            } else {
                event.target.value = conteoActual[prodId].cantidad;
            }
        }
    });
    
    // Mostrar la fila vacía al inicio
    actualizarTablaVisual();
    buscarInput.focus();
});
</script>
{% endblock %}