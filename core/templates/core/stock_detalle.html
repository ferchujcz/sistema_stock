{% extends 'core/base.html' %}

{% block content %}

{% if sucursal_seleccionada %}
    <h1 class="mb-3">Stock Detallado - Sucursal: {{ sucursal_seleccionada.nombre }}</h1>
{% elif sucursal_actual %}
    <h1 class="mb-3">Stock Detallado - Mi Sucursal: {{ sucursal_actual.nombre }}</h1>
{% else %}
    <h1 class="mb-3">Stock Detallado (Visión Global)</h1>
{% endif %}

<ul class="nav nav-tabs" id="filtroStockTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="todos-tab" data-bs-toggle="tab" data-bs-target="#todos-pane" type="button" role="tab">
            <i class="bi bi-list-ul"></i> Todos los Productos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link text-danger" id="alertas-tab" data-bs-toggle="tab" data-bs-target="#alertas-pane" type="button" role="tab">
            <i class="bi bi-exclamation-triangle"></i> Solo Alertas
        </button>
    </li>
</ul>

<div class="tab-content" id="filtroStockTabsContent">

    <div class="tab-pane fade show active" id="todos-pane" role="tabpanel" tabindex="0">
        <div class="card shadow-sm border-top-0 rounded-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tablaStockTodos" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cant. Góndola</th>
                                <th>Cant. Depósito</th>
                                <th>Vencimiento Próximo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for info in info_consolidada %}
                                {% if info.dias_para_vencer is not None and info.dias_para_vencer < 0 %}
                                    <tr class="table-dark">
                                {% elif info.en_riesgo %}
                                    <tr class="table-danger">
                                {% elif info.dias_para_vencer is not None and info.dias_para_vencer <= 20 %}
                                    <tr class="table-warning">
                                {% else %}
                                    <tr>
                                {% endif %}

                                    <td>{{ info.producto.nombre }}</td>
                                    <td>{{ info.total_gondola }}</td>
                                    <td>{{ info.total_deposito }}</td>
                                    <td data-order="{{ info.vencimiento_proximo|date:'Ymd' }}">
                                        {% if info.vencimiento_proximo %}
                                            {{ info.vencimiento_proximo|date:"d/m/Y" }} ({{ info.dias_para_vencer }} días)
                                        {% else %}
                                            <span class="text-muted">No perecedero</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if info.dias_para_vencer is not None and info.dias_para_vencer < 0 %}
                                            <span class="badge bg-dark">VENCIDO</span>
                                        {% elif info.en_riesgo %}
                                            <span class="badge bg-danger">¡Riesgo!</span>
                                        {% elif info.dias_para_vencer is not None and info.dias_para_vencer <= 20 %}
                                            <span class="badge bg-warning text-dark">Vence Pronto</span>
                                        {% else %}
                                            <span class="badge bg-success">OK</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'detalle_producto_lotes' info.producto.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Ver Lotes
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="alertas-pane" role="tabpanel" tabindex="0">
        <div class="card shadow-sm border-top-0 rounded-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tablaStockAlertas" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cant. Góndola</th>
                                <th>Cant. Depósito</th>
                                <th>Vencimiento Próximo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for info in info_consolidada %}
                                {% if info.en_riesgo or info.dias_para_vencer is not None and info.dias_para_vencer <= 20 %}
                                    
                                    {% if info.dias_para_vencer is not None and info.dias_para_vencer < 0 %}
                                        <tr class="table-dark">
                                    {% elif info.en_riesgo %}
                                        <tr class="table-danger">
                                    {% elif info.dias_para_vencer is not None and info.dias_para_vencer <= 20 %}
                                        <tr class="table-warning">
                                    {% endif %}

                                    <td>{{ info.producto.nombre }}</td>
                                    <td>{{ info.total_gondola }}</td>
                                    <td>{{ info.total_deposito }}</td>
                                    <td data-order="{{ info.vencimiento_proximo|date:'Ymd' }}">
                                        {% if info.vencimiento_proximo %}
                                            {{ info.vencimiento_proximo|date:"d/m/Y" }} ({{ info.dias_para_vencer }} días)
                                        {% else %}
                                            <span class="text-muted">No perecedero</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if info.dias_para_vencer is not None and info.dias_para_vencer < 0 %}
                                            <span class="badge bg-dark">VENCIDO</span>
                                        {% elif info.en_riesgo %}
                                            <span class="badge bg-danger">¡Riesgo!</span>
                                        {% elif info.dias_para_vencer is not None and info.dias_para_vencer <= 20 %}
                                            <span class="badge bg-warning text-dark">Vence Pronto</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'detalle_producto_lotes' info.producto.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Ver Lotes
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script>
    $(document).ready(function() {
        // Configuración común para DataTables
        const dtConfig = {
            responsive: true,
            language: {
                "decimal": "",
                "emptyTable": "No hay datos disponibles en la tabla",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "infoPostFix": "",
                "thousands": ",",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            order: [[ 3, 'asc' ]] // Ordenar por vencimiento
        };

        new DataTable('#tablaStockTodos', dtConfig);
        new DataTable('#tablaStockAlertas', dtConfig);
    });
</script>
{% endblock %}